// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// Table des utilisateurs
model User {
  id            Int       @id @default(autoincrement())
  name          String
  email         String    @unique
  passwordHash  String    @map("password_hash")
  role          String    @default("user")
  stars         Int       @default(0)
  level         Int       @default(1)
  xp            Int       @default(0)
  theme         String    @default("light")
  timezone      String    @default("Europe/Paris")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastLogin     DateTime  @default(now()) @map("last_login")

  // Relations
  activities        Activity[]
  challengesAsChallenger Challenge[] @relation("ChallengerChallenges")
  challengesAsFriend     Challenge[] @relation("FriendChallenges")
  userBadges        UserBadge[]
  eventsCreated     Event[]      @relation("EventCreator")
  userEvents        UserEvent[]
  motivationsSent   Motivation[] @relation("SentMotivations")
  motivationsReceived Motivation[] @relation("ReceivedMotivations")
  userConnections   UserConnection[]
  dailyChallenges   DailyChallenge[] @relation("DailyChallenges")
  userChallenges    UserChallenge[] @relation("UserChallenges")
  customChallenges  CustomChallenge[] @relation("CustomChallenges")
  notifications     Notification[]
  
  // Relations pour les amiti√©s
  friendshipsRequested  Friendship[] @relation("FriendshipRequester")
  friendshipsReceived   Friendship[] @relation("FriendshipAddressee")
  
  // Relations pour les d√©fis entre amis
  friendChallengesSent      FriendChallenge[] @relation("FriendChallengeChallenger")
  friendChallengesReceived  FriendChallenge[] @relation("FriendChallengeChallenged")
  friendChallengesWon       FriendChallenge[] @relation("FriendChallengeWinner")

  @@map("users")
}

// Table des activit√©s (habitudes)
model Activity {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  name      String
  frequency String    @default("daily")
  color     String    @default("#3B82F6")
  icon      String    @default("‚úÖ")
  category  String    @default("other")
  startDate DateTime? @map("start_date") @db.Date
  imageUrl  String?   @map("image_url")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityLogs     ActivityLog[]
  challenges       Challenge[]
  friendChallenges FriendChallenge[]

  @@index([userId])
  @@map("activities")
}

// Table des logs d'activit√©s (validation quotidienne)
model ActivityLog {
  id         Int      @id @default(autoincrement())
  activityId Int      @map("activity_id")
  date       DateTime @db.Date
  isDone     Boolean  @default(false) @map("is_done")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([activityId, date])
  @@index([activityId])
  @@index([date])
  @@map("activity_logs")
}

// Table des d√©fis
model Challenge {
  id             Int       @id @default(autoincrement())
  challengerId   Int       @map("challenger_id")
  friendId       Int       @map("friend_id")
  activityId     Int       @map("activity_id")
  status         String    @default("pending")
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  challengerScore Int      @default(0) @map("challenger_score")
  friendScore    Int      @default(0) @map("friend_score")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  challenger User     @relation("ChallengerChallenges", fields: [challengerId], references: [id], onDelete: Cascade)
  friend     User     @relation("FriendChallenges", fields: [friendId], references: [id], onDelete: Cascade)
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([challengerId])
  @@index([friendId])
  @@map("challenges")
}

// Table des badges
model Badge {
  id             Int      @id @default(autoincrement())
  title          String
  description    String?
  conditionType  String   @map("condition_type")
  conditionValue Int      @map("condition_value")
  icon           String   @default("üèÜ")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  userBadges UserBadge[]

  @@map("badges")
}

// Table des badges utilisateurs
model UserBadge {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  badgeId  Int      @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

// Table des √©v√©nements
model Event {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  isActive    Boolean  @default(true) @map("is_active")
  createdBy   Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  creator         User?            @relation("EventCreator", fields: [createdBy], references: [id])
  userEvents      UserEvent[]
  eventChallenges EventChallenge[]

  @@map("events")
}

// Table de participation aux √©v√©nements
model UserEvent {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  eventId  Int      @map("event_id")
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@map("user_events")
}

// Table des motivations entre amis
model Motivation {
  id         Int      @id @default(autoincrement())
  senderId   Int      @map("sender_id")
  receiverId Int      @map("receiver_id")
  emoji      String
  comment    String?
  date       DateTime @default(dbgenerated("CURRENT_DATE")) @db.Date
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  sender   User @relation("SentMotivations", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMotivations", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId])
  @@map("motivations")
}

// Table des connexions utilisateurs
model UserConnection {
  id               Int      @id @default(autoincrement())
  userId           Int      @map("user_id")
  lastLogin        DateTime @default(now()) @map("last_login")
  streakConnexions Int      @default(1) @map("streak_connexions")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_connections")
}

// Table des d√©fis quotidiens par utilisateur
model DailyChallenge {
  id                 Int      @id @default(autoincrement())
  userId             Int      @map("user_id")
  challengeDate      DateTime @map("challenge_date") @db.Date
  
  // D√©fi activit√©s
  activitiesCompleted Int      @default(0) @map("activities_completed")
  activitiesTarget    Int      @default(3) @map("activities_target")
  activitiesReward    Int      @default(5) @map("activities_reward")
  activitiesClaimed   Boolean  @default(false) @map("activities_claimed")
  
  // D√©fi sport
  sportCompleted     Int      @default(0) @map("sport_completed")
  sportTarget        Int      @default(1) @map("sport_target")
  sportReward        Int      @default(3) @map("sport_reward")
  sportClaimed       Boolean  @default(false) @map("sport_claimed")
  
  // D√©fi sant√©
  healthCompleted    Int      @default(0) @map("health_completed")
  healthTarget       Int      @default(1) @map("health_target")
  healthReward       Int      @default(3) @map("health_reward")
  healthClaimed      Boolean  @default(false) @map("health_claimed")
  
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation("DailyChallenges", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeDate])
  @@index([userId])
  @@index([challengeDate])
  @@map("daily_challenges")
}

// Table de suivi des d√©fis utilisateurs
model UserChallenge {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  challengeId     Int      @map("challenge_id")
  status          String   @default("active")
  progress        Int      @default(0)
  completed       Boolean  @default(false)
  starReward      Int      @default(5) @map("star_reward")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user      User      @relation("UserChallenges", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_challenges")
}

// D√©fis personnalis√©s cr√©√©s par les utilisateurs (Niveau 5+)
model CustomChallenge {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  title           String
  description     String?
  targetValue     Int      @map("target_value") @default(1)
  currentValue    Int      @map("current_value") @default(0)
  unit            String   @default("fois")
  starReward      Int      @default(10) @map("star_reward")
  icon            String   @default("üéØ")
  color           String   @default("#EC4899")
  difficulty      String   @default("medium")
  isCompleted     Boolean  @default(false) @map("is_completed")
  completedAt     DateTime? @map("completed_at")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation("CustomChallenges", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isCompleted])
  @@map("custom_challenges")
}

// Table des notifications
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String   // "activity_late", "event_started", "challenge_completed", etc.
  title     String
  message   String
  link      String?  // Lien vers la page concern√©e
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// Table des d√©fis d'√©v√©nements
model EventChallenge {
  id          Int      @id @default(autoincrement())
  eventId     Int      @map("event_id")
  title       String
  description String?
  targetValue Int      @map("target_value") @default(1)
  unit        String   @default("fois")
  starReward  Int      @default(15) @map("star_reward")
  icon        String   @default("üéØ")
  color       String   @default("#EC4899")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_challenges")
}

// Table des amiti√©s
model Friendship {
  id          Int      @id @default(autoincrement())
  requesterId Int      @map("requester_id")
  addresseeId Int      @map("addressee_id")
  status      String   @default("pending") // pending, accepted, declined
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
  @@map("friendships")
}

// Table des d√©fis entre amis
model FriendChallenge {
  id            Int       @id @default(autoincrement())
  challengerId  Int       @map("challenger_id")
  challengedId  Int       @map("challenged_id")
  activityId    Int?      @map("activity_id")
  eventId       Int?      @map("event_id")
  title         String
  description   String?
  targetValue   Int       @map("target_value") @default(7) // Ex: 7 jours
  unit          String    @default("jours")
  starReward    Int       @default(20) @map("star_reward")
  status        String    @default("pending") // pending, accepted, declined, active, completed, cancelled
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  challengerProgress Int  @default(0) @map("challenger_progress")
  challengedProgress Int  @default(0) @map("challenged_progress")
  winnerId      Int?      @map("winner_id")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  challenger User      @relation("FriendChallengeChallenger", fields: [challengerId], references: [id], onDelete: Cascade)
  challenged User      @relation("FriendChallengeChallenged", fields: [challengedId], references: [id], onDelete: Cascade)
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: SetNull)
  winner     User?     @relation("FriendChallengeWinner", fields: [winnerId], references: [id], onDelete: SetNull)

  @@index([challengerId])
  @@index([challengedId])
  @@index([status])
  @@map("friend_challenges")
}

