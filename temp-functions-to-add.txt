
// R√©clamer la r√©compense d'un d√©fi journalier
export async function claimDailyChallenge(challengeId: string) {
  try {
    const session = await auth();
    if (!session?.user?.email) {
      throw new Error('Non connect√©');
    }

    const userResult = await sql`
      SELECT id FROM users WHERE email = ${session.user.email}
    `;

    if (userResult.length === 0) {
      throw new Error('Utilisateur non trouv√©');
    }

    const userId = userResult[0].id;
    const today = new Date().toISOString().split('T')[0];

    const challengeResult = await sql`
      SELECT * FROM daily_challenges
      WHERE user_id = ${userId}
      AND challenge_date = ${today}
    `;

    if (challengeResult.length === 0) {
      throw new Error('D√©fi non trouv√©');
    }

    const challenge = challengeResult[0];
    const claimedKey = `${challengeId}_claimed`;
    const completedKey = `${challengeId}_completed`;
    const targetKey = `${challengeId}_target`;
    const rewardKey = `${challengeId}_reward`;

    if (challenge[claimedKey]) {
      throw new Error('R√©compense d√©j√† r√©clam√©e');
    }

    if (challenge[completedKey] < challenge[targetKey]) {
      throw new Error('D√©fi pas encore compl√©t√©');
    }

    const reward = Number(challenge[rewardKey]);

    await sql`
      UPDATE daily_challenges
      SET ${sql(claimedKey)} = true
      WHERE user_id = ${userId}
      AND challenge_date = ${today}
    `;

    const { addUserXp } = await import('./level-actions');
    await addUserXp(session.user.email, reward);

    console.log(`üéÅ R√©compense r√©clam√©e! +${reward} √©toiles`);
    revalidatePath('/dashboard');
    revalidatePath('/dashboard/challenges');
  } catch (error) {
    console.error('‚ùå Erreur lors de la r√©clamation:', error);
    throw error;
  }
}

// D√©bloquer un badge avec des √©toiles
export async function unlockBadge(badgeId: string) {
  try {
    const session = await auth();
    if (!session?.user?.email) {
      throw new Error('Non connect√©');
    }

    const userResult = await sql`
      SELECT id, stars FROM users WHERE email = ${session.user.email}
    `;

    if (userResult.length === 0) {
      throw new Error('Utilisateur non trouv√©');
    }

    const user = userResult[0];

    const badgeResult = await sql`
      SELECT id, star_cost, title FROM badges WHERE id = ${badgeId}
    `;

    if (badgeResult.length === 0) {
      throw new Error('Badge non trouv√©');
    }

    const badge = badgeResult[0];

    if (user.stars < badge.star_cost) {
      throw new Error("Pas assez d'√©toiles");
    }

    const alreadyUnlocked = await sql`
      SELECT id FROM user_badges
      WHERE user_id = ${user.id} AND badge_id = ${badgeId}
    `;

    if (alreadyUnlocked.length > 0) {
      throw new Error('Badge d√©j√† d√©bloqu√©');
    }

    await sql`
      INSERT INTO user_badges (user_id, badge_id)
      VALUES (${user.id}, ${badgeId})
    `;

    await sql`
      UPDATE users
      SET stars = stars - ${badge.star_cost}
      WHERE id = ${user.id}
    `;

    console.log(`üèÜ Badge d√©bloqu√©: ${badge.title} (-${badge.star_cost} √©toiles)`);
    revalidatePath('/dashboard/badges');
    revalidatePath('/dashboard/challenges');
  } catch (error) {
    console.error('‚ùå Erreur lors du d√©blocage du badge:', error);
    throw error;
  }
}
